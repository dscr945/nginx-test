---
# make a slave
- name: update mysql root password for all root accounts 
  mysql_user: name=root host={{ item }} password={{ mysql_root_db_pass }} 
  with_items: 
      - 127.0.0.1 
      - ::1 
      - localhost 
  tags: [mysql,mysql-init]

- name: ensure anonymous users are not in the database 
  mysql_user: name='' login_user=root login_password={{ mysql_root_db_pass }} state=absent 
  tags: mysql

- name: remove the test database 
  mysql_db: name=test login_user=root login_password={{ mysql_root_db_pass }} state=absent
  tags: mysql

- name: Create the databases 
  mysql_db: name={{ item.name }} login_user=root login_password={{ mysql_root_db_pass }} state=present 
  with_items: mysql_db 
  when: mysql_db|lower() != 'none'
  tags: mysql

- name: Create the database users 
  mysql_user: login_user=root  login_password={{ mysql_root_db_pass }} name={{ item.name }} password={{ item.pass|default("missyou") }}  priv={{ item.priv|default("test.*:ALL") }} state=present host={{ item.host | default("localhost") }} 
  with_items: mysql_users 
  when: mysql_users|lower() != 'none'
  tags: mysql

- name: Create the replication users 
  mysql_user: login_user=root login_password={{ mysql_root_db_pass }} name={{ item.name }} host={{ item.host | default("%") }} password={{ item.pass }}  priv={{ item.priv }}  state=present 
  with_items: mysql_repl_user 
  tags: mysql

- name: copy database jiajiale
  copy: src=jiajiale.20150612.sql dest={{ item.sql_file }}
  with_items: mysql_master_info
  when: mysql_master_info is defined and mysql_slave is defined
  tags: [mysql,mysql-slave,mysql-init]
  
- name: stop slave 
  mysql_replication: login_user=root login_password={{ mysql_root_db_pass }} mode=stopslave 
  when: mysql_master_info is defined and mysql_slave is defined
  tags: [mysql,mysql-slave,mysql-init]

- name: init database jiajiale
  shell: '/usr/bin/mysql -p{{mysql_root_db_pass}} < {{ item.sql_file }} '
  with_items: mysql_master_info
  when: mysql_master_info is defined and mysql_slave is defined
  tags: [mysql,mysql-slave,mysql-init]

- name: Change the master in slave to start the replication 
  mysql_replication: login_user=root login_password={{ mysql_root_db_pass }} mode=changemaster 
    master_host={{ item.host }}
    master_log_file={{ item.log_file }} 
    master_log_pos={{ item.log_pos }} 
    master_user={{ item.user }} 
    master_password={{ item.pass }} 
  with_items: mysql_master_info
  when: mysql_master_info is defined and mysql_slave is defined 
  tags: [mysql,mysql-slave,mysql-init]

- name: start slave in slave to start the replication 
  mysql_replication: login_user=root login_password={{ mysql_root_db_pass }} mode=startslave 
  when: mysql_master_info is defined and mysql_slave is defined
  tags: [mysql,mysql-slave,mysql-init]
